#!/usr/local/bin/bash

. "$WORKSPACE/shell/utilities.sh"
cd "$WORKSPACE/platform/stage"

up() {
    FOLDER="$1" && shift # application, vpn etc.
    (cd "1-provisioning/$FOLDER" && with-echo terraform apply --var-file=../vars.tfvars)
}

down() {
    FOLDER="$1" && shift # application, vpn etc.
    (cd "1-provisioning/$FOLDER" && with-echo terraform destroy --var-file=../vars.tfvars)
}

deploy() {
    (cd "2-deployment" && with-echo ansible-playbook --forks="20" playbook.yml)
}

redeploy() {
    PROGRAM_NAME="$1" && shift
    (cd "2-deployment" && with-echo ansible-playbook --forks="20" --limit="$PROGRAM_NAME" --tags="redeploy" playbook.yml)
}

all() {
    with-echo up
    with-echo deploy
}

totp() {
    OTP_FILES="$(ls -1 artifacts/vpn/do-*otp-uri.txt | sort -r | rev | uniq -s 29 | rev)"

    echo "$OTP_FILES" | while read -r OTP_FILE; do
        cat "$OTP_FILE" | qr >"$OTP_FILE.png"
        OTP_FILENAME="$(basename "$OTP_FILE")"
        echo "Opening: ${OTP_FILENAME:0:7}"
        open -W "$OTP_FILE.png"
        rm "$OTP_FILE.png" "$OTP_FILE"
    done

}

COMMAND="$1" && shift && $COMMAND "$@"
